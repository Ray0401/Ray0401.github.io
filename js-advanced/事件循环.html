<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.27">
    <title>事件循环机制（event loop） | xuhairui's blog</title><meta name="description" content="hello">
    <link rel="preload" href="/assets/js/runtime~app.3701f8ad.js" as="script"><link rel="preload" href="/assets/css/styles.113454fc.css" as="style"><link rel="preload" href="/assets/js/567.ff38b5b2.js" as="script"><link rel="preload" href="/assets/js/app.54e3ef76.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.113454fc.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name">xuhairui&#39;s blog</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/" class="nav-link" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/" class="nav-link" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item">关于我</p><ul class=""><li><!--[--><a href="/my/" class="nav-link sidebar-item" aria-label="关于我"><!--[--><!--]--> 关于我 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item active">js高级</p><ul class=""><li><!--[--><a href="/js-advanced/%E5%9F%BA%E7%A1%80.html" class="nav-link sidebar-item" aria-label="基础"><!--[--><!--]--> 基础 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/js-advanced/this.html" class="nav-link sidebar-item" aria-label="this 的理解"><!--[--><!--]--> this 的理解 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/js-advanced/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-item active" aria-label="事件循环机制（event loop）"><!--[--><!--]--> 事件循环机制（event loop） <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/js-advanced/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF.html#js-内存机制" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="js 内存机制"><!--[--><!--]--> js 内存机制 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/js-advanced/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF.html#栈与堆" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="栈与堆"><!--[--><!--]--> 栈与堆 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/js-advanced/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF.html#栈" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="栈"><!--[--><!--]--> 栈 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/js-advanced/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF.html#堆" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="堆"><!--[--><!--]--> 堆 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/js-advanced/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF.html#总结" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="总结"><!--[--><!--]--> 总结 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/js-advanced/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF.html#浏览器循环事件" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="浏览器循环事件"><!--[--><!--]--> 浏览器循环事件 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/js-advanced/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF.html#宏任务" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="宏任务"><!--[--><!--]--> 宏任务 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/js-advanced/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF.html#微任务" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="微任务"><!--[--><!--]--> 微任务 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/js-advanced/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF.html#node-事件循环" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="node 事件循环"><!--[--><!--]--> node 事件循环 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/js-advanced/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF.html#宏任务-1" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="宏任务"><!--[--><!--]--> 宏任务 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/js-advanced/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF.html#微任务-1" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="微任务"><!--[--><!--]--> 微任务 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/js-advanced/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF.html#node-和浏览器-eventloop-的主要区别" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="node 和浏览器 EventLoop 的主要区别"><!--[--><!--]--> node 和浏览器 EventLoop 的主要区别 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a href="/js-advanced/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98.html" class="nav-link sidebar-item" aria-label="浏览器缓存"><!--[--><!--]--> 浏览器缓存 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/js-advanced/%E5%8E%9F%E5%9E%8B%E4%B8%8E%E5%8E%9F%E5%9E%8B%E9%93%BE.html" class="nav-link sidebar-item" aria-label="原型与原型链"><!--[--><!--]--> 原型与原型链 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/js-advanced/%E7%BB%A7%E6%89%BF.html" class="nav-link sidebar-item" aria-label="继承"><!--[--><!--]--> 继承 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/js-advanced/%E5%B8%B8%E8%A7%81%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html" class="nav-link sidebar-item" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/js-advanced/%E6%89%8B%E5%86%99%E6%BA%90%E7%A0%81.html" class="nav-link sidebar-item" aria-label="手写源码以及实现各种功能"><!--[--><!--]--> 手写源码以及实现各种功能 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">路由</p><ul class=""><li><!--[--><a href="/router/" class="nav-link sidebar-item" aria-label="前端路由"><!--[--><!--]--> 前端路由 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">vue</p><ul class=""><li><!--[--><a href="/vue/vue2.html" class="nav-link sidebar-item" aria-label="vue2"><!--[--><!--]--> vue2 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue/vue3.html" class="nav-link sidebar-item" aria-label="vue3"><!--[--><!--]--> vue3 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">react</p><ul class=""><li><!--[--><a href="/react/" class="nav-link sidebar-item" aria-label="介绍"><!--[--><!--]--> 介绍 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/react/react.html" class="nav-link sidebar-item" aria-label="正篇"><!--[--><!--]--> 正篇 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/react/hooks.html" class="nav-link sidebar-item" aria-label="hooks"><!--[--><!--]--> hooks <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">vite</p><ul class=""><li><!--[--><a href="/vite/" class="nav-link sidebar-item" aria-label="为什么选 vite"><!--[--><!--]--> 为什么选 vite <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vite/debug.html" class="nav-link sidebar-item" aria-label="debug 源码"><!--[--><!--]--> debug 源码 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">node</p><ul class=""><li><!--[--><a href="/node/node.html" class="nav-link sidebar-item" aria-label="前言"><!--[--><!--]--> 前言 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">electron</p><ul class=""><li><!--[--><a href="/electron/" class="nav-link sidebar-item" aria-label="介绍"><!--[--><!--]--> 介绍 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/electron/start.html" class="nav-link sidebar-item" aria-label="正篇"><!--[--><!--]--> 正篇 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">工程化</p><ul class=""><li><!--[--><a href="/engineering/webpack.html" class="nav-link sidebar-item" aria-label="webpack"><!--[--><!--]--> webpack <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/engineering/babel.html" class="nav-link sidebar-item" aria-label="babel"><!--[--><!--]--> babel <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/engineering/multirepo&amp;monorepo.html" class="nav-link sidebar-item" aria-label="multi-repo &amp; mono-repo"><!--[--><!--]--> multi-repo &amp; mono-repo <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">Uniapp</p><ul class=""><li><!--[--><a href="/uniapp/" class="nav-link sidebar-item" aria-label="Uniapp 5+项目重构分享"><!--[--><!--]--> Uniapp 5+项目重构分享 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="事件循环机制-event-loop" tabindex="-1"><a class="header-anchor" href="#事件循环机制-event-loop" aria-hidden="true">#</a> 事件循环机制（event loop）</h1><p>要理解事件循环机制,先熟悉 js 内存机制</p><h2 id="js-内存机制" tabindex="-1"><a class="header-anchor" href="#js-内存机制" aria-hidden="true">#</a> js 内存机制</h2><p>js 具有自动垃圾回收机制,所以对于前端开发来说,内存空间并不是一个经常被提及的概念</p><p>在 js 中,每一个数据都需要一个存储空间.内存空间又分为两种: <strong>栈内存(stack)与堆内存(heap)</strong></p><h2 id="栈与堆" tabindex="-1"><a class="header-anchor" href="#栈与堆" aria-hidden="true">#</a> 栈与堆</h2><h3 id="栈" tabindex="-1"><a class="header-anchor" href="#栈" aria-hidden="true">#</a> 栈</h3><p><strong>栈内存一般存储基础数据类型</strong></p><ul><li>Number</li><li>String</li><li>Boolean</li><li>Symbol</li><li>null</li><li>undefined</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>定义一个变量 a,系统自动为我们分配存储空间.我们可以直接操作保存在栈内存空间的值,因此技术数据类型都是<code>按值访问</code></p><h3 id="堆" tabindex="-1"><a class="header-anchor" href="#堆" aria-hidden="true">#</a> 堆</h3><p><strong>堆内存一般存储引用数据类型</strong></p><ul><li>Object</li><li>Array</li><li>Function(<strong>函数的主体内容存在于堆中,但函数的引用地址是存在栈中的,函数执行的时候在栈里执行</strong>)</li><li>Date</li><li>...</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 变量a存在于栈中,{ name: &#39;xuhairui&#39; }作为对象存在于堆内存中</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;xuhairui&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 变量b存在于栈中,[1, 2, 3]作为对象存在于堆内存中</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>所以当要访问堆内存中的引用数据类型时,实际上是<code>先从栈中获取了该对象的地址引用(或者地址指针)</code>,然后<code>再从堆内存中取得我们所要的数据</code></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> m <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">20</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> n <span class="token operator">=</span> m<span class="token punctuation">;</span>
n<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 15</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="/images/js/heap.jpg" alt=""></p><h3 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h3><p>栈:</p><ul><li>存储基本数据类型</li><li>按值访问</li><li>存储的大小固定</li><li>由系统自动分配内存空间</li><li>空间小,运行效率高</li><li><strong>先进后出,后进先出</strong>(队列是先进先出)</li><li>栈中的 DOM，ajax，setTimeout 会依次进入到队列中,当栈中代码执行完毕后，再将队列中的事件放到执行栈中依次执行</li><li>微任务与宏任务</li></ul><p>堆:</p><ul><li>存储引用数据类型</li><li>按引用访问</li><li>存储的值大小不定,可动态调整</li><li>主要用来存放对象</li><li>空间大,但是运行效率相对较低</li><li>无需存储,可根据引用直接获取</li></ul><h2 id="浏览器循环事件" tabindex="-1"><a class="header-anchor" href="#浏览器循环事件" aria-hidden="true">#</a> 浏览器循环事件</h2><p>JavaScript 代码的执行过程中，除了依靠函数调用<code>栈</code>来搞定函数的执行顺序外，还依靠任务队列(task queue)来搞定另外一些代码的执行。整个执行过程，我们称为事件循环过程。一个线程中，事件循环是唯一的，但是任务队列可以拥有多个。任务队列又分为 macro-task（宏任务）与 micro-task（微任务），在最新标准中，它们被分别称为 task 与 jobs。</p><h3 id="宏任务" tabindex="-1"><a class="header-anchor" href="#宏任务" aria-hidden="true">#</a> 宏任务</h3><p>宏任务大致包括：</p><ul><li>script（整体代码）</li><li>setTimeout</li><li>setInterval</li><li>setImmediate</li><li>I/O</li><li>UI render</li></ul><h3 id="微任务" tabindex="-1"><a class="header-anchor" href="#微任务" aria-hidden="true">#</a> 微任务</h3><p>微任务大致包括：</p><ul><li>process.nextTick</li><li>Promise</li><li>Async/await（实际就是 promise）</li><li>MutationObserver(html5 新特性)</li></ul><p>流程图大致如下：</p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcfr5av3d5j30zk0hc3zm.jpg" style="zoom:50%;"><p>总结：执行宏任务，然后执行宏任务产生的微任务，若微任务在执行过程中产生新的微任务，则继续执行新产生的微任务，所有的微任务执行完毕后，再回到宏任务中进行下一轮循环。例如：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;script start&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;async1 end&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;async2 end&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;setTimeout&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Promise&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;promise1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;promise2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;script end&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>执行结果</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>script start
async2 end
Promise
script end
async1 end
promise1
promise2
setTimeout
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>执行过程:</p><ul><li>执行过程,输出&quot;script start&quot;;</li><li>执行 async1(),调用 async2(),输出&quot;async2 end&quot;,此时将会保留 async1 函数的上下文,然后跳出 async1 函数;</li><li>遇到 setTimeout 函数,放入到宏任务中;</li><li>执行 Promise,输出&quot;Promise&quot;,遇到.then,产生第一个微任务;</li><li>输出&quot;script end&quot;;</li><li>当前宏任务执行完毕,开始执行当前宏任务产生的微任务,输出&quot;promise1&quot;,遇到.then,产生新的微任务;</li><li>执行新产生的微任务,输出&quot;promise2&quot;;当前微任务队列执行完毕,执行权回到 async1</li><li>输出&quot;async1 end&quot;;</li><li>最后执行下一个宏任务,输出&quot;setTimeout&quot;</li></ul><p>Async/await 执行顺序:</p><ul><li><p>如果 await 后面直接跟的一个一个变量,如 await 1,这种情况相当于直接把 await 后面的代码注册为一个微任务;</p></li><li><p>如果 await 后面跟的是一个异步函数的调用,如下面的例子:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;script start&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;async1 end&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;async2 end&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;async2 end1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;setTimeout&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Promise&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;promise1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;promise2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;script end&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>那么最后打印的值依次为:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>script start
async2 end
Promise
script end
async2 end1
promise1
promise2
async1 end
setTimeout
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li></ul><h2 id="node-事件循环" tabindex="-1"><a class="header-anchor" href="#node-事件循环" aria-hidden="true">#</a> node 事件循环</h2><p>node 中也有宏任务和微任务</p><h3 id="宏任务-1" tabindex="-1"><a class="header-anchor" href="#宏任务-1" aria-hidden="true">#</a> 宏任务</h3><ul><li>setTimeout</li><li>setInterval</li><li>setImmediate</li><li>script(整体代码)</li><li>I/O 操作等</li></ul><h3 id="微任务-1" tabindex="-1"><a class="header-anchor" href="#微任务-1" aria-hidden="true">#</a> 微任务</h3><ul><li>process.nextTick()</li><li>new Promise().then(回调)等</li></ul><h4 id="node-的事件循环的阶段顺序为" tabindex="-1"><a class="header-anchor" href="#node-的事件循环的阶段顺序为" aria-hidden="true">#</a> node 的事件循环的阶段顺序为：</h4><p>输入数据阶段(incoming data)-&gt;轮询阶段(poll)-&gt;检查阶段(check)-&gt;关闭事件回调阶段(close callback)-&gt;定时器检测阶段(timers)-&gt;I/O 事件回调阶段(I/O callbacks)-&gt;闲置阶段(idle, prepare)-&gt;轮询阶段...</p><h4 id="timers-阶段的执行时机变化" tabindex="-1"><a class="header-anchor" href="#timers-阶段的执行时机变化" aria-hidden="true">#</a> timers 阶段的执行时机变化</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;timer1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;promise1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;timer2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;promise2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li><p>如果版本是 node11+,一旦执行一个阶段里的一个宏任务就立刻执行微任务队列,这就跟浏览器端运行一致,最后的结果为:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>timer1
promise1
timer2
promise2
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li><li><p>如果版本是 node10 及以前,得看第一个定时器执行完,第二个定时器是否在完成队列中</p><ul><li><p>如果第二个定时器还未在完成队列中,最后的结果为:</p><p>timer1=&gt;promise1=&gt;timer2=&gt;promise2</p></li><li><p>如果第二个定时器已经在完成队列中,最后的结果为:</p><p>timer1=&gt;timer2=&gt;promise1=&gt;promise2</p></li></ul></li></ul><p>总结: 如果是 node11 版本一旦执行一个阶段里的一个宏任务(setTimeout,setInterval 和 setImmediate)就立刻执行对应的微任务队列。</p><h2 id="node-和浏览器-eventloop-的主要区别" tabindex="-1"><a class="header-anchor" href="#node-和浏览器-eventloop-的主要区别" aria-hidden="true">#</a> node 和浏览器 EventLoop 的主要区别</h2><p>两者最主要的区别在于浏览器中的微任务是在每个相应的宏任务中执行的，而 nodejs 中的微任务是在不同阶段之间执行的。</p><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">2022/10/8 下午1:33:36</span></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: cgxuhairui@163.com">xuhairui</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"> ← <a href="/js-advanced/this.html" class="nav-link" aria-label="this 的理解"><!--[--><!--]--> this 的理解 <!--[--><!--]--></a></span><span class="next"><a href="/js-advanced/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98.html" class="nav-link" aria-label="浏览器缓存"><!--[--><!--]--> 浏览器缓存 <!--[--><!--]--></a> → </span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.3701f8ad.js" defer></script><script src="/assets/js/567.ff38b5b2.js" defer></script><script src="/assets/js/app.54e3ef76.js" defer></script>
  </body>
</html>
